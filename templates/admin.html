<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Administración</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin:0; background:#f3f4f6; padding:20px; }
    h1, h2, h3 { color:#1e3a8a; }
    input, button { padding:8px; font-size:16px; margin:8px 0; border-radius:6px; }
    button { background:#1e3a8a; color:white; border:none; cursor:pointer; }
    #msg, #edit-msg { margin-top:12px; font-weight:bold; }
    #calendario .fc-event-title { font-weight:bold; margin-bottom:4px; }
    #calendario img { width:100%; max-height:100px; object-fit:cover; border-radius:6px; margin-top:4px; }
    #modal-editar { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#0008; z-index:999; justify-content:center; align-items:center; }
    #modal-editar .modal-content { background:white; padding:20px; border-radius:8px; width:300px; }
  </style>
</head>
<body>
  <h1>Gestión de Eventos – Auditorio P. Ibiza</h1>

  <div style="display:flex; gap:40px; flex-wrap:wrap;">
    <div style="flex:1; min-width:300px;">
      <h2>Crear nuevo evento</h2>
      <form id="evento-form" enctype="multipart/form-data">
        <label>Nombre del evento:</label><br>
        <input type="text" name="nombre" required /><br>
        <label>Fecha:</label><br>
        <input type="date" name="fecha" required /><br>
        <label>Imagen del evento:</label><br>
        <input type="file" name="imagen" accept="image/*" required /><br>
        <button type="submit">Crear evento</button>
      </form>
      <p id="msg"></p>
    </div>

    <div style="flex:2; min-width:500px;">
      <h2>Calendario de eventos</h2>
      <div id="calendario" style="max-width:900px; margin:auto;"></div>
    </div>
  </div>

  <div id="modal-editar">
    <div class="modal-content">
      <h3>Editar evento</h3>
      <input type="text" id="edit-nombre" /><br>
      <input type="date" id="edit-fecha" /><br>
      <input type="file" id="edit-imagen" accept="image/*" /><br>
      <button onclick="guardarEdicion()">Guardar cambios</button>
      <button onclick="reiniciarEvento()">Reiniciar evento</button>
      <button onclick="desactivarEvento()">Desactivar evento</button>
      <button onclick="reactivarEvento()">Reactivar evento</button>
      <button onclick="eliminarEvento()">Eliminar evento</button>
      <button onclick="cerrarModal()">Cancelar</button>
      <p id="edit-msg"></p>
    </div>
  </div>

  <script>
    let eventoEditando = null;

    document.getElementById("evento-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const res = await fetch("/api/create_event_with_image", { method: "POST", body: formData });
      const data = await res.json();
      document.getElementById("msg").textContent = data.ok ? `✅ Evento creado con ID ${data.evento_id}` : `❌ ${data.msg}`;
      if (data.ok) e.target.reset();
      cargarCalendario();
    });

    function abrirModal(evento) {
      eventoEditando = evento;
      document.getElementById("edit-nombre").value = evento.title;
      document.getElementById("edit-fecha").value = evento.startStr;
      document.getElementById("modal-editar").style.display = "flex";
    }

    function cerrarModal() {
      document.getElementById("modal-editar").style.display = "none";
      document.getElementById("edit-msg").textContent = "";
    }

    async function guardarEdicion() {
      const nombre = document.getElementById("edit-nombre").value.trim();
      const fecha = document.getElementById("edit-fecha").value;
      const imagen = document.getElementById("edit-imagen").files[0];
      const formData = new FormData();
      formData.append("nombre", nombre);
      formData.append("fecha", fecha);
      formData.append("activo", 1);
      if (imagen) formData.append("imagen", imagen);
      const res = await fetch(`/api/evento/${eventoEditando.extendedProps.id}`, { method: "PUT", body: formData });
      const data = await res.json();
      document.getElementById("edit-msg").textContent = data.ok ? "✅ Evento actualizado." : `❌ ${data.msg}`;
      if (data.ok) cerrarModal(), cargarCalendario();
    }

    async function reiniciarEvento() {
      if (confirm("¿Reiniciar este evento?")) {
        const res = await fetch(`/api/evento/reset/${eventoEditando.extendedProps.id}`, { method: "POST" });
        const data = await res.json();
        alert(data.msg);
        cerrarModal();
        cargarCalendario();
      }
    }

    async function desactivarEvento() {
      if (confirm("¿Desactivar este evento?")) {
        const formData = new FormData();
        formData.append("nombre", eventoEditando.title);
        formData.append("fecha", eventoEditando.startStr);
        formData.append("activo", 0);
        const res = await fetch(`/api/evento/${eventoEditando.extendedProps.id}`, { method: "PUT", body: formData });
        const data = await res.json();
        alert(data.msg);
        cerrarModal();
        cargarCalendario();
      }
    }

    async function reactivarEvento() {
      if (confirm("¿Reactivar este evento?")) {
        const formData = new FormData();
        formData.append("nombre", eventoEditando.title);
        formData.append("fecha", eventoEditando.startStr);
        formData.append("activo", 1);
        const res = await fetch(`/api/evento/${eventoEditando.extendedProps.id}`, { method: "PUT", body: formData });
        const data = await res.json();
        alert(data.msg);
        cerrarModal();
        cargarCalendario();
      }
    }

    async function eliminarEvento() {
      if (confirm("¿Eliminar este evento? Esta acción no se puede deshacer.")) {
        const res = await fetch(`/api/evento/${eventoEditando.extendedProps.id}`, { method: "DELETE" });
        const data = await res.json();
        alert(data.msg);
        cerrarModal();
        cargarCalendario();
      }
    }

    async function cargarCalendario() {
      const res = await fetch("/api/eventos");
      const eventos = await res.json();
      const calendarEl = document.getElementById("calendario");
      calendarEl.innerHTML = "";
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        locale: "es",
        headerToolbar: { left: "prev,next today", center: "title", right: "" },
        events: eventos.map(ev => ({
          title: ev.nombre,
          start: ev.fecha,
          extendedProps: { id: ev.id, activo: ev.activo },
          display: "block",
          color: ev.activo == 0 ? "#999999" : "#3788d8"
        })),
        eventClick: info => abrirModal(info.event),
        eventDidMount: info => {
          const id = info.event.extendedProps.id;
          const activo = info.event.extendedProps.activo;
          const img = document.createElement("img");
          img.src = `/static/eventos/${id}.jpg`;
          img.onerror = () => img.style.display = "none";
          info.el.appendChild(img);
          if (!activo) {
            info.el.style.opacity = "0.6";
            info.el.style.textDecoration = "line-through";
          }
        }
      });
      calendar.render();
    }

    document.addEventListener("DOMContentLoaded", cargarCalendario);
  </script>
</body>
</html>