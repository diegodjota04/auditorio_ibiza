<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Validación de Entradas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin:0; background:#f3f4f6; }
    header { background:#1e3a8a; color:white; padding:12px 20px; font-size:20px; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
    main { display:flex; flex-direction:row; height:calc(100vh - 60px); }
    .panel { flex:1; padding:20px; overflow:auto; }
    .row { display:flex; margin:4px 0; }
    .row-label { width:30px; font-weight:bold; margin-right:8px; }
    .seat { width:32px; height:32px; margin:2px; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:11px; color:white; user-select:none; -webkit-user-select:none; }
    .disponible { background:#22c55e; }
    .vendido { background:#f59e0b; }
    .bloqueado { background:#6b7280; }
    .validado { background:#2563eb; }
    #reader { width:100%; margin-top:12px; display:none; }
    .btn { background:#1e3a8a; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin-top:8px; }
    input { margin-top:12px; padding:6px; width:100%; border:1px solid #ccc; border-radius:6px; }
  </style>
</head>
<body>
  <header>
    <span>Validación de Entradas</span>
    <a href="/">Volver a ventas</a>
  </header>
  <main>
    <section class="panel">
      <h2>Evento</h2>
      <select id="evento-select"></select>
      <h2>Mapa</h2>
      <div id="seat-grid">Seleccione evento</div>
    </section>
    <section class="panel">
      <h2>Escáner QR</h2>
      <button class="btn" id="start-scan">Iniciar escaneo</button>
      <div id="reader"></div>
      <p id="last-scan"></p>
      <input type="text" id="manual-seat" placeholder="Ej: A10" />
      <button class="btn" onclick="validarManual()">Validar manualmente</button>
    </section>
  </main>

  <script>
    const rows = [..."ABCDEFGHIJKLMNOPQ", ..."RSTU"];
    const maxByRow = {};
    "ABCDEFGHIJKLMNOPQ".split("").forEach(r=>maxByRow[r]=16);
    "RSTU".split("").forEach(r=>maxByRow[r]=13);

    let eventoId = null;
    let html5QrCode;
    let escaneando = false;

    async function cargarEventos() {
      const res = await fetch("/api/eventos");
      const eventos = await res.json();
      const sel = document.getElementById("evento-select");
      eventos.forEach(ev => {
        const opt = document.createElement("option");
        opt.value = ev.id;
        opt.textContent = `${ev.nombre} (${ev.fecha})`;
        sel.appendChild(opt);
      });
      sel.addEventListener("change", () => {
        eventoId = sel.value;
        cargarAsientos();
      });
    }

    async function cargarAsientos() {
      const res = await fetch(`/api/seats/${eventoId}`);
      const data = await res.json();
      const byId = {};
      data.forEach(s => byId[s.id] = s.status);
      const grid = document.getElementById("seat-grid");
      grid.innerHTML = "";

      rows.forEach(r => {
        const rowDiv = document.createElement("div");
        rowDiv.className = "row";
        const label = document.createElement("span");
        label.className = "row-label";
        label.textContent = r;
        rowDiv.appendChild(label);

        for (let n = maxByRow[r]; n >= 1; n--) {
          const id = `${r}${n}`;
          const status = byId[id] || "disponible";
          const d = document.createElement("div");
          d.className = `seat ${status}`;
          d.textContent = n;
          d.id = `seat-${id}`;
          rowDiv.appendChild(d);
        }
        grid.appendChild(rowDiv);
      });
    }

    async function marcarValidado(seatId) {
      if (!eventoId || !seatId) return;
      try {
        const res = await fetch(`/api/validate/${eventoId}`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ seat_id: seatId })
        });

        if (!res.ok) {
          const text = await res.text();
          console.error("Error del servidor:", text);
          document.getElementById("last-scan").innerText = `❌ Error ${res.status}: ${text}`;
          return;
        }

        const data = await res.json();
        if (data.ok) {
          const el = document.getElementById(`seat-${seatId}`);
          if (el) {
            el.classList.remove("disponible","vendido","bloqueado");
            el.classList.add("validado");
          }
          document.getElementById("last-scan").innerText = `✅ Entrada validada: ${seatId}`;
        } else {
          document.getElementById("last-scan").innerText = `❌ ${data.msg || "No se pudo validar"}`;
        }
      } catch (err) {
        console.error("Error inesperado:", err);
        document.getElementById("last-scan").innerText = `❌ Error inesperado: ${err.message}`;
      }
    }

    function onScanSuccess(decodedText) {
      if (escaneando) return;
      escaneando = true;
      const seatId = decodedText.trim();
      marcarValidado(seatId).finally(() => {
        escaneando = false;
      });
    }

    function onScanFailure(error) {
      // silencioso
    }

    function validarManual() {
      const seatId = document.getElementById("manual-seat").value.trim();
      if (seatId) marcarValidado(seatId);
    }

    document.getElementById("start-scan").addEventListener("click", async ()=>{
      document.getElementById("reader").style.display = "block";
      try {
        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode("reader");
        }
        const devices = await Html5Qrcode.getCameras();
        if (devices && devices.length) {
          const cameraId = devices[0].id;
          html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            onScanSuccess,
            onScanFailure
          );
        } else {
          alert("No se encontró cámara disponible");
        }
      } catch (err) {
        console.error("Error al iniciar escáner:", err);
        alert("No se pudo iniciar el escáner");
      }
    });

    cargarEventos();
  </script>
</body>
</html>