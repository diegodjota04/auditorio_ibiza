<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Validación de Entradas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <span>Auditorio P. Ibiza</span>
    <nav>
      <a href="/" class="nav-link">Inicio</a>
      <a href="/admin" class="nav-link">Administración</a>
      <a href="/validar" class="nav-link">Validar entradas</a>
    </nav>
  </header>

  <main class="validacion-layout">
    <section class="panel panel-izquierdo">
      <h2>Evento</h2>
      <label for="evento-select">Seleccione un evento:</label>
      <select id="evento-select" name="evento" class="evento-select">
        <option value="">-- Seleccione --</option>
      </select>

      <h2>Mapa</h2>
      <div class="info-superior">
        <img id="evento-preview" src="" alt="Imagen del evento" class="evento-img" />
        <div class="chart-wrap">
          <canvas id="ocupacionChart" aria-label="Gráfica circular de ocupación" role="img"></canvas>
          <canvas id="detalleChart" aria-label="Gráfica de barras vendidas vs validadas" role="img"></canvas>
        </div>
      </div>

      <div class="escenario-label">Vista desde el escenario</div>
      <div id="seat-grid">Seleccione un evento</div>
    </section>

    <section class="panel panel-derecho">
      <h2>Escáner QR</h2>
      <button class="btn" id="start-scan">Iniciar escaneo</button>
      <div id="reader"></div>
      <p id="last-scan"></p>

      <label for="manual-seat">Validación manual</label>
      <input type="text" id="manual-seat" placeholder="Ej: A10" />
      <button class="btn" id="manual-btn">Validar manualmente</button>
    </section>
  </main>

  <script>
    const rows = [..."ABCDEFGHIJKLMNOPQ", ..."RSTU"];
    const maxByRow = {};
    "ABCDEFGHIJKLMNOPQ".split("").forEach(r => maxByRow[r] = 16);
    "RSTU".split("").forEach(r => maxByRow[r] = 13);

    let eventoId = null;
    let html5QrCode = null;
    let escaneando = false;
    let ocupacionChart = null;
    let detalleChart = null;

    async function cargarEventos() {
      try {
        const res = await fetch("/api/eventos");
        if (!res.ok) throw new Error(`Error ${res.status}`);
        const eventos = await res.json();
        const sel = document.getElementById("evento-select");
        sel.innerHTML = '<option value="">-- Seleccione --</option>';
        eventos.forEach(ev => {
          const opt = document.createElement("option");
          opt.value = ev.id;
          opt.textContent = `${ev.nombre} (${ev.fecha})${ev.activo ? "" : " [inactivo]"}`;
          sel.appendChild(opt);
        });
        sel.addEventListener("change", async () => {
          eventoId = sel.value;
          if (eventoId) {
            document.getElementById("evento-preview").src = `/static/eventos/${eventoId}.jpg`;
            await cargarAsientos();
            await cargarEstadisticas(eventoId);
          } else {
            document.getElementById("seat-grid").innerText = "❌ No se ha seleccionado ningún evento.";
          }
        });
      } catch (err) {
        console.error("Error al cargar eventos:", err);
        document.getElementById("seat-grid").innerText = "❌ No se pudieron cargar los eventos.";
      }
    }

    async function cargarAsientos() {
      if (!eventoId) return;
      try {
        const res = await fetch(`/api/seats/${eventoId}`);
        if (!res.ok) throw new Error(`Error ${res.status}`);
        const data = await res.json();
        const byId = {};
        data.forEach(s => byId[s.id] = s.status);
        const grid = document.getElementById("seat-grid");
        grid.innerHTML = "";
        rows.forEach(r => {
          const rowDiv = document.createElement("div");
          rowDiv.className = "row";
          const label = document.createElement("span");
          label.className = "row-label";
          label.textContent = r;
          rowDiv.appendChild(label);
          for (let n = maxByRow[r]; n >= 1; n--) {
            const id = `${r}${n}`;
            const status = byId[id] || "disponible";
            const d = document.createElement("div");
            d.className = `seat ${status}`;
            d.textContent = n;
            d.id = `seat-${id}`;
            rowDiv.appendChild(d);
          }
          grid.appendChild(rowDiv);
        });
      } catch (err) {
        console.error("Error al cargar asientos:", err);
        document.getElementById("seat-grid").innerText = "❌ No se pudo cargar el mapa de asientos.";
      }
    }

    function pintarSeatValidado(seatId) {
      const el = document.getElementById(`seat-${seatId}`);
      if (!el) return;
      el.classList.remove("disponible", "vendido", "bloqueado");
      el.classList.add("validado", "flash");
      setTimeout(() => el.classList.remove("flash"), 600);
    }

    async function marcarValidado(seatId) {
      if (!eventoId || !seatId) return;
      try {
        const res = await fetch(`/api/validate/${eventoId}`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ seat_id: seatId })
        });
        if (!res.ok) {
          const text = await res.text();
          console.error("Error del servidor:", text);
          document.getElementById("last-scan").innerText = `❌ Error ${res.status}: ${text}`;
          return;
        }
        const data = await res.json();
        if (data.ok) {
          pintarSeatValidado(seatId);
          document.getElementById("last-scan").innerText = `✅ Entrada validada: ${seatId}`;
          try {
            const beep = new Audio("/static/beep.mp3");
            beep.play().catch(() => {});
          } catch {}
          cargarEstadisticas();
        } else {
          document.getElementById("last-scan").innerText = `❌ ${data.msg || "No se pudo validar"}`;
        }
      } catch (err) {
        console.error("Error inesperado:", err);
        document.getElementById("last-scan").innerText = `❌ Error inesperado: ${err.message}`;
      }
    }

    function onScanSuccess(decodedText) {
      if (escaneando) return;
      escaneando = true;
      const seatId = decodedText.trim();
      marcarValidado(seatId).finally(() => escaneando = false);
    }

    function onScanFailure(_error) {}

    function validarManual() {
      const seatId = document.getElementById("manual-seat").value.trim();
      if (seatId) marcarValidado(seatId);
    }

    document.getElementById("start-scan").addEventListener("click", async () => {
      const readerEl = document.getElementById("reader");
      readerEl.style.display = "block";
      try {
        if (!html5QrCode) {
          html5QrCode = new Html5Qrcode("reader");
        }
        const devices = await Html5Qrcode.getCameras();
        if (devices && devices.length) {
          const cameraId = devices[0].id;
          await html5QrCode.start(cameraId, { fps: 10, qrbox: 250 }, onScanSuccess, onScanFailure);
        } else {
          alert("No se encontró cámara disponible");
        }
      } catch (err) {
        console.error("Error al iniciar escáner:", err);
        alert("No se pudo iniciar el escáner");
      }
    });

    document.getElementById("manual-btn").addEventListener("click", validarManual);

    async function cargarEstadisticas() {
      if (!eventoId) return;
      try {
        const res = await fetch(`/api/report/${eventoId}`);
        if (!res.ok) throw new Error(`Error ${res.status}`);
        const data = await res.json();
        const { counts } = data;
        const total = Object.values(counts || {}).reduce((a, b) => a + b, 0);
        const vendidos = counts?.vendido || 0;
                const validados = counts?.validado || 0;
        const disponibles = counts?.disponible || 0;

        if (ocupacionChart) ocupacionChart.destroy();
        if (detalleChart) detalleChart.destroy();

        const ctx1 = document.getElementById("ocupacionChart").getContext("2d");
        ocupacionChart = new Chart(ctx1, {
          type: "doughnut",
          data: {
            labels: ["Vendidos", "Validados", "Disponibles"],
            datasets: [{
              data: [vendidos, validados, disponibles],
              backgroundColor: ["#f59e0b", "#2563eb", "#22c55e"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });

        const ctx2 = document.getElementById("detalleChart").getContext("2d");
        detalleChart = new Chart(ctx2, {
          type: "bar",
          data: {
            labels: ["Vendidos", "Validados"],
            datasets: [{
              label: "Entradas",
              data: [vendidos, validados],
              backgroundColor: ["#f59e0b", "#2563eb"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      } catch (err) {
        console.error("Error al cargar estadísticas:", err);
      }
    }

    window.addEventListener("DOMContentLoaded", cargarEventos);
  </script>
</body>
</html>